#!/usr/bin/env node

require.paths.push(__dirname + '/../lib');

var sys = require('sys'),
    fs = require('fs'),
    exerciser = require('exerciser');
var a=process.argv;

if (a.length < 5 || a.length >6) {
    sys.log("usage: "+a[1]+" filename host:port total-requests [concurrency]");
    process.exit();
}

var hostandport=a[3].split(':'),requests = a[4],concurrent=a[5];


if (!hostandport[1]) hostandport[1]=80;

e = new exerciser.Exerciser({host:hostandport[0],port:hostandport[1]});
lines=fs.readFileSync(a[2]).toString().split("\n");
var currentLine=0,totalLines=lines.length;
var handleLine=function() {
    line=lines[currentLine];
    var headers;
    pathAndHeaders=line.split("\t");
    if (pathAndHeaders[1])
        headers=JSON.parse(pathAndHeaders[1]);
    e.run({path:pathAndHeaders[0],requests:requests,concurrent:concurrent,headers:headers}, function(stats) {
        sys.log(pathAndHeaders[0]+ " "+stats.totalTime/requests+" "+stats.timeouts);
        if (requests != stats.successful)
            console.log("status codes: %j",stats.statusCodes);
        if (++currentLine<totalLines)
            handleLine();
        });
};
handleLine();